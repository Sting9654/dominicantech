//CREACION DE LA BASE DE DATOS

CREATE DATABASE DOMINICAN_TECH_CO;

//CREACION DE LAS TABLAS

//TABLA PRODUCTOS

CREATE TABLE TBL_PRODUCT(
    PROD_ID INT AUTO_INCREMENT PRIMARY KEY,
    PROD_NAME VARCHAR(50) NOT NULL,
    PROD_DESCRIPTION TEXT,
    PROD_UNIT_PRICE DECIMAL(10,2) DEFAULT 0,
    PROD_STOCK INT,
    PROD_AVAILABLE BOOLEAN DEFAULT TRUE,
    PROD_CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
    )

//TABLA CLIENTES

CREATE TABLE TBL_CLIENT(
	CLI_ID INT PRIMARY KEY AUTO_INCREMENT,
    CLI_NAME VARCHAR(50) NOT NULL,
    CLI_LAST_NAME VARCHAR(50) NOT NULL,
    CLI_EMAIL VARCHAR(255),
    CLI_RNC CHAR(9) NOT NULL UNIQUE,
    CLI_ADDRESS TEXT NOT NULL,
    CLI_CREATED_AT TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
)

//INSERCION DE CLIENTES

INSERT INTO TBL_CLIENT (CLI_NAME, CLI_LAST_NAME, CLI_EMAIL, CLI_RNC, CLI_ADDRESS) VALUES
('Juan', 'Perez', 'juan.perez@example.com', '123456789', '123 Main St, Santo Domingo'),
('Maria', 'Gomez', 'maria.gomez@example.com', '987654321', '456 Elm St, Santo Domingo'),
('Carlos', 'Rodriguez', 'carlos.rodriguez@example.com', '456789123', '789 Oak St, Santo Domingo');


//TABLA OPERACIONES

CREATE TABLE TBL_OPERATION(
	OP_ID INT PRIMARY KEY AUTO_INCREMENT,
    OP_NAME VARCHAR(50) NOT NULL,
    OP_DESCRIPTION TEXT,
    OP_CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
)

//INSERCION DE OPERACIONES

INSERT INTO `tbl_operation` (`OP_ID`, `OP_NAME`, `OP_DESCRIPTION`, `OP_CREATED_AT`) VALUES (NULL, 'ENTRADA', 'INGRESO DE PRODUCTO A TIENDA', current_timestamp()), (NULL, 'VENTA MAYORISTA', 'VENTA MAYORISTA', current_timestamp()), (NULL, 'VENTA MINORISTA', 'VENTA MINORISTA', current_timestamp());

//TABLA DE MOVIMIENTOS DE PRODUCTOS

CREATE TABLE TBL_MOV_INVENTORY (
    MOV_ID INT PRIMARY KEY AUTO_INCREMENT,
    MOV_OPERATION_ID INT NOT NULL,
    MOV_PRODUCT_ID INT NOT NULL,
    MOV_QUANTITY INT NOT NULL,
    MOV_CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (MOV_OPERATION_ID) REFERENCES TBL_OPERATION(OP_ID) ON DELETE NO ACTION ON UPDATE NO ACTION,
    FOREIGN KEY (MOV_PRODUCT_ID) REFERENCES TBL_PRODUCT(PROD_ID) ON DELETE NO ACTION ON UPDATE NO ACTION
);

//INSERCIONES DE PRODUCTOS

INSERT INTO TBL_PRODUCT (PROD_NAME, PROD_DESCRIPTION, PROD_UNIT_PRICE, PROD_STOCK, PROD_AVAILABLE) VALUES
('DELL - OPTIPLEX SMALL FORM FACTOR PLUS 7020', 'COMPUTADORA DELL OPTIPLEX SMALL FORM FACTOR PLUS 7020, INTEL CORE I5 PROCESSOR 14500 (24MB CACHE, 14 CORES, 20 THREADS, UP TO 5.0 GHZ TURBO, 65W. RAM 16GB (1X16 GB) DDR5, DISCO M.2 2230 512GB PCIE NVME SSD CLASS 35. INTEL INTEGRATED GRAPHIC, 3X DISPLAY PORT, 8X DVD+/-RW 9.5MM, MOUSE + TECLADO SPANISH, WIN11 PRO, 3 AÑOS GARANTIA.', 1411.99, 100, TRUE),
('INTEL - NUC7I5DNKPC1', 'COMPUTADORA NUC INTEL NUC 7 BUSINESS MINI PC, CORE I5 VPRO, 8GB RAM, 256GB SSD', 858.68, 200, TRUE),
('HP - COMPUTADORA HP SMART BUY PRODESK 400 G6 SFF', 'COMPUTADORA HP SMART BUY PRODESK 400 G6 SFF, I5-9500, 256GB SSD, 8GB, DVD, W10 PRO', 919.81, 300, TRUE);


//TABLA DE ORDENES

CREATE TABLE TBL_ORDER (
	ORD_ID INT PRIMARY KEY AUTO_INCREMENT,
	ORD_SALE_TYPE INT NOT NULL,
    ORD_CLIENT_ID INT NOT NULL,
    ORD_CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

FOREIGN KEY (ORD_TIPO_VENTA) REFERENCES tbl_operation(OP_ID) ON DELETE CASCADE ON UPDATE NO ACTION
        FOREIGN KEY (ORD_CLIENT_ID) REFERENCES tbl_client(CLI_ID) ON DELETE CASCADE ON UPDATE NO ACTION
)

//INSERCION DE 2 FACTURAS PARA SOLO 3 REGISTRO EN LA TABLA DE CLIENTES

INSERT INTO TBL_ORDER (ORD_SALE_TYPE, ORD_CLIENT_ID)
SELECT 2, CLI_ID
FROM TBL_CLIENT
LIMIT 3;

//TABLA DETALLE ORDENES

CREATE TABLE TBL_ORDER_DETAIL(
	ODTL_ID INT PRIMARY KEY AUTO_INCREMENT,
    ODTL_ORDER_ID INT NOT NULL,
    ODTL_PRODUCT_ID INT NOT NULL,
    ODTL_QUANTITY INT NOT NULL,
    ODTL_DISCOUNT DOUBLE DEFAULT 0,
    ODTL_UNIT_PRICE DECIMAL(10,2) NOT NULL,
    ODTL_TOTAL_PRICE DECIMAL(10,2) NOT NULL,

    FOREIGN KEY (ODTL_ORDER_ID) REFERENCES TBL_ORDER(ORD_ID) ON DELETE CASCADE ON UPDATE NO ACTION,
        FOREIGN KEY (ODTL_PRODUCT_ID) REFERENCES TBL_PRODUCT(PROD_ID) ON DELETE CASCADE ON UPDATE NO ACTION
)

//CONSULTA PARA OBTENER PRODUCTOS CON DISPONIBILIDAD DE INVENTARIO

SELECT * FROM `tbl_product` WHERE PROD_STOCK > 0

//CONSULTA PARA VER LAS ORDENES FILTRADAS POR ID

SELECT O.*, C.CLI_NAME, C.CLI_LAST_NAME, C.CLI_EMAIL
FROM tbl_order o
JOIN tbl_client c ON o.ORD_CLIENT_ID = c.CLI_ID
WHERE o.ORD_CLIENT_ID = 1;

//CONSULTA PARA Encontrar todos los detalle_orden de una orden en específico

SELECT od.ODTL_ID, od.ODTL_ORDER_ID, p.PROD_NAME, p.PROD_DESCRIPTION, od.ODTL_QUANTITY
FROM TBL_ORDER_DETAIL od
JOIN TBL_PRODUCT p ON od.ODTL_PRODUCT_ID = p.PROD_ID
WHERE od.ODTL_ID = 2;

//Vista para obtener todos los detalles de una orden

CREATE OR REPLACE VIEW vw_order_detail AS SELECT
    ODTL_ID AS VW_ID,
    ODTL_ORDER_ID AS VW_ORDER_ID,
    ODTL_PRODUCT_ID AS VW_PRODUCT_ID,
    PROD_NAME AS VW_PRODUCT,
    ODTL_QUANTITY AS VW_QUANTITY,
    ODTL_UNIT_PRICE AS VW_UNIT_PRICE,
    ODTL_DISCOUNT AS VW_DISCOUNT,
    ODTL_TOTAL_AMOUNT AS VW_TOTAL_AMOUNT
FROM
    tbl_order_detail
JOIN tbl_product ON tbl_product.PROD_ID = tbl_order_detail.ODTL_PRODUCT_ID;

//Vista para movimientos para mostrar los movimientos a los clientes INVENTARIO

CREATE OR REPLACE VIEW VW_MOVIMIENTOS_INVENTARIO 
AS 
SELECT 
    MOV_ID AS VW_ID, 
    MOV_CREATED_AT AS VW_CREATED_AT, 
    MOV_OPERATION_ID AS VW_OPERATION_ID, 
    OP_NAME AS VW_OPERATION_NAME, 
    MOV_PRODUCT_ID AS VW_PRODUCT_ID, 
    PROD_NAME AS VW_PRODUCT, 
    MOV_QUANTITY AS VW_QUANTITY 
    FROM tbl_mov_inventory 
    JOIN tbl_operation ON tbl_operation.OP_ID = tbl_mov_inventory.MOV_OPERATION_ID 
    JOIN tbl_product ON tbl_product.PROD_ID = tbl_mov_inventory.MOV_PRODUCT_ID;

//vista para ver el historial de transacciones

CREATE OR REPLACE VIEW VW_SALES AS SELECT
    `ORD_ID` AS VW_ORDER_ID,
    `ORD_CREATED_AT` AS VW_DATE,
    `ORD_SALE_TYPE` AS VW_SALE_TYPE_ID,
    `OP_NAME` AS VW_SALE_TYPE,
    `ORD_CLIENT_ID` AS VW_CLIENT_ID,
    CONCAT(`CLI_NAME`, " ", `CLI_LAST_NAME`) AS VW_CLIENT_FULLNAME,
    SUM(`ODTL_TOTAL_AMOUNT`) AS VW_TOTAL_AMOUNT
FROM
    `tbl_order`
JOIN tbl_order_detail ON tbl_order_detail.ODTL_ORDER_ID = tbl_order.ORD_ID
JOIN tbl_client ON tbl_order.ORD_CLIENT_ID = tbl_client.CLI_ID
JOIN tbl_operation ON tbl_order.ORD_SALE_TYPE = tbl_operation.OP_ID
GROUP BY
    VW_ORDER_ID ASC;